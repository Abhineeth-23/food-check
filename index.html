<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Food Intake Estimator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #f1f5f9; }
    </style>

    <!-- Firebase Imports (kept for your UI) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config missing â†’ Public Mode");
                window.userId = 'Public-Session-User';
                window.isAuthReady = true;
                return;
            }

            try {
                setLogLevel('Debug');

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        try {
                            const anonymousUser = await signInAnonymously(window.auth);
                            window.userId = anonymousUser.user.uid;
                        } catch (error) {
                            console.error(error);
                            window.userId = crypto.randomUUID();
                        }
                    }
                    window.isAuthReady = true;
                });
            } catch (error) {
                console.error("Firebase init error:", error);
            }
        };

        initFirebase();
    </script>

</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-300">

        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">AI Food Intake Estimator ðŸ¥—</h1>
        <p class="text-center text-gray-500 mb-8">Upload a picture of your food to get instant nutritional insights.</p>

        <div class="grid md:grid-cols-2 gap-8 mb-8">

            <!-- Image Upload Section -->
            <div class="bg-gray-50 p-6 rounded-lg border-2 border-dashed border-indigo-300">
                <label class="block text-lg font-semibold mb-4 cursor-pointer">1. Upload Food Image</label>
                <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="previewImage(event)">

                <div id="image-placeholder" class="h-64 flex items-center justify-center border border-gray-300 rounded-lg overflow-hidden bg-white cursor-pointer"
                    onclick="document.getElementById('imageUpload').click()">
                    <span id="placeholder-text" class="text-gray-400">Click to select an image</span>
                    <img id="image-preview" class="hidden w-full h-full object-cover" alt="Food preview">
                </div>

                <button onclick="analyzeFood()" id="analyzeButton"
                    class="w-full mt-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md disabled:bg-indigo-400"
                    disabled>
                    Analyze Food
                </button>
            </div>

            <!-- Results Section -->
            <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">

                <h2 class="text-xl font-semibold text-gray-800 mb-4">2. Estimation & Impact</h2>

                <!-- Loading -->
                <div id="loading" class="hidden flex flex-col items-center justify-center h-64 text-indigo-600">
                    <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10"></circle>
                        <path class="opacity-75" d="M4 12a8 8 0 018-8"></path>
                    </svg>
                    <p class="text-sm font-medium">Analyzing image...</p>
                </div>

                <!-- Results -->
                <div id="results" class="hidden custom-scroll max-h-96 overflow-y-auto">
                    <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-md">
                        <p class="text-sm font-medium text-indigo-700">Food Item: <span id="food-description"></span></p>
                        <p class="text-sm font-medium text-indigo-700">Serving: <span id="serving-size"></span></p>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                        <div class="text-center p-3 bg-red-50 rounded-lg border"><p class="text-xs">Calories</p><p id="calories" class="text-lg font-bold"></p></div>
                        <div class="text-center p-3 bg-green-50 rounded-lg border"><p class="text-xs">Protein</p><p id="protein" class="text-lg font-bold"></p></div>
                        <div class="text-center p-3 bg-yellow-50 rounded-lg border"><p class="text-xs">Fat</p><p id="fat" class="text-lg font-bold"></p></div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg border"><p class="text-xs">Carbs</p><p id="carbs" class="text-lg font-bold"></p></div>
                    </div>

                    <h3 class="font-bold mb-1">Daily Impact</h3>
                    <p id="daily-impact" class="text-sm bg-gray-100 p-3 rounded-md mb-4"></p>

                    <h3 class="font-bold mb-1">Minimal Impact Suggestion</h3>
                    <p id="suggestion-minimal" class="text-sm bg-green-50 p-3 border-l-4 border-green-500 rounded-md mb-4"></p>

                    <h3 class="font-bold mb-1">Significant Impact Suggestion</h3>
                    <p id="suggestion-significant" class="text-sm bg-red-50 p-3 border-l-4 border-red-500 rounded-md"></p>
                </div>

                <!-- Error -->
                <div id="error-message" class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                    <p class="font-bold">Analysis Failed</p>
                    <p id="error-text" class="text-sm"></p>
                </div>

            </div>
        </div>

        <div class="text-center text-xs text-gray-400 mt-4">
            <p>User ID: <span id="display-user-id">Loading...</span></p>
        </div>

    </div>

    <!-- Main Script -->
    <script>
        const imagePreview = document.getElementById('image-preview');
        const placeholderText = document.getElementById('placeholder-text');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const displayUserId = document.getElementById('display-user-id');

        let imageBase64 = null;

        function previewImage(event) {
            resultsDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            const file = event.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                placeholderText.classList.add('hidden');
                analyzeButton.disabled = false;
                imageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function getBackoffDelay(attempt) {
            return Math.pow(2, attempt) * 1000;
        }

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.status === 429 && i < maxRetries - 1) {
                        await new Promise(r => setTimeout(r, getBackoffDelay(i)));
                        continue;
                    }
                    if (!res.ok) throw new Error(res.status);
                    return res;
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    await new Promise(r => setTimeout(r, getBackoffDelay(i)));
                }
            }
        }

        async function analyzeFood() {
            if (!imageBase64) {
                showError("Please upload an image before analyzing.");
                return;
            }

            analyzeButton.disabled = true;
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            const apiUrl = "https://abhineeth23-food-estimator-proxy.hf.space/analyze";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: "Analyze the food item in the image." },
                            { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }
                        ]
                    }
                ]
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) throw new Error("Empty response");

                const clean = text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(clean);

                updateResultsUI(data);

            } catch (e) {
                console.error(e);
                showError("The AI could not analyze the image.");
            } finally {
                loadingDiv.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        function updateResultsUI(data) {
            const format = (n) => typeof n === "number" ? n.toFixed(1) : "N/A";

            document.getElementById('food-description').textContent = data.foodDescription;
            document.getElementById('serving-size').textContent = `${format(data.estimatedServingSizeGrams)} g`;
            document.getElementById('calories').textContent = format(data.caloriesKcal);
            document.getElementById('protein').textContent = format(data.proteinGrams);
            document.getElementById('fat').textContent = format(data.fatGrams);
            document.getElementById('carbs').textContent = format(data.carbsGrams);
            document.getElementById('daily-impact').textContent = data.dailyImpactSummary;
            document.getElementById('suggestion-minimal').textContent = data.suggestionMinimalImpact;
            document.getElementById('suggestion-significant').textContent = data.suggestionSignificantImpact;

            resultsDiv.classList.remove('hidden');
        }

        function showError(msg) {
            errorText.textContent = msg;
            errorDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
        }

        window.onload = () => {
            const interval = setInterval(() => {
                if (window.isAuthReady) {
                    displayUserId.textContent = window.userId;
                    clearInterval(interval);
                }
            }, 100);
        };
    </script>

</body>
</html>
