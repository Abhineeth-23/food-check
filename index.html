<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Food Intake Estimator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #f1f5f9; }
    </style>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config missing ‚Üí Public Mode");
                window.userId = 'Public-Session-User';
                window.isAuthReady = true;
                return;
            }

            try {
                setLogLevel('Debug');

                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) window.userId = user.uid;
                    else {
                        try {
                            const u = await signInAnonymously(window.auth);
                            window.userId = u.user.uid;
                        } catch {
                            window.userId = crypto.randomUUID();
                        }
                    }
                    window.isAuthReady = true;
                });
            } catch (e) { console.error(e); }
        };

        initFirebase();
    </script>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">AI Food Intake Estimator ü•ó</h1>
        <p class="text-center text-gray-500 mb-8">Upload or capture a food picture ‚Äî optionally describe your dish for higher accuracy.</p>

        <div class="grid md:grid-cols-2 gap-8 mb-8">

            <!-- LEFT SIDE: Upload + Camera + User Fields -->
            <div class="bg-gray-50 p-6 rounded-lg border-2 border-dashed border-indigo-300">

                <label class="block text-lg font-semibold mb-4 cursor-pointer">1. Add a Food Image</label>

                <!-- Hidden Upload Input -->
                <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="previewImage(event)">

                <!-- Hidden Camera Capture Input -->
                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="previewImage(event)">

                <!-- Preview Box -->
                <div id="image-placeholder"
                    class="h-64 flex items-center justify-center border border-gray-300 rounded-lg overflow-hidden bg-white cursor-pointer"
                    onclick="document.getElementById('imageUpload').click()">

                    <span id="placeholder-text" class="text-gray-400">Click to select an image</span>
                    <img id="image-preview" class="hidden w-full h-full object-cover" alt="Preview">
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 mt-4">
                    <button 
                        class="w-1/2 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                        onclick="document.getElementById('imageUpload').click()">
                        Upload Image üìÅ
                    </button>

                    <button 
                        class="w-1/2 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                        onclick="openCamera()">
                        Take Photo üì∏
                    </button>
                </div>

                <!-- OPTIONAL HINT FIELDS -->
                <div class="mt-6 space-y-4">
                    <div>
                        <label class="block text-sm font-semibold">Optional: Dish Name</label>
                        <input id="user-dish-name" type="text" placeholder="e.g., Chicken Biryani"
                            class="w-full p-2 border rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold">Optional: Portion Size</label>
                        <input id="user-quantity" type="text" placeholder="e.g., 1 medium plate"
                            class="w-full p-2 border rounded-lg">
                    </div>
                </div>

                <button onclick="analyzeFood()" id="analyzeButton"
                    class="w-full mt-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 disabled:bg-indigo-400"
                    disabled>
                    Analyze Food
                </button>
            </div>

            <!-- RIGHT SIDE: Results -->
            <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">

                <h2 class="text-xl font-semibold mb-4">2. Estimation & Impact</h2>

                <!-- Loading -->
                <div id="loading" class="hidden flex flex-col items-center justify-center h-64 text-indigo-600">
                    <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10"></circle>
                        <path class="opacity-75" d="M4 12a8 8 0 018-8"></path>
                    </svg>
                    <p class="text-sm">Analyzing image...</p>
                </div>

                <!-- Results -->
                <div id="results" class="hidden custom-scroll max-h-96 overflow-y-auto">

                    <div class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-md">
                        <p><b>Food:</b> <span id="food-description"></span></p>
                        <p><b>Serving:</b> <span id="serving-size"></span></p>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                        <div class="p-3 bg-red-50 text-center rounded border"><p>Calories</p><p id="calories"></p></div>
                        <div class="p-3 bg-green-50 text-center rounded border"><p>Protein</p><p id="protein"></p></div>
                        <div class="p-3 bg-yellow-50 text-center rounded border"><p>Fat</p><p id="fat"></p></div>
                        <div class="p-3 bg-blue-50 text-center rounded border"><p>Carbs</p><p id="carbs"></p></div>
                    </div>

                    <h3 class="font-bold">Daily Impact</h3>
                    <p id="daily-impact" class="p-3 bg-gray-100 rounded mb-3"></p>

                    <h3 class="font-bold">Minimal Impact</h3>
                    <p id="suggestion-minimal" class="p-3 bg-green-50 border-l-4 border-green-500 rounded mb-3"></p>

                    <h3 class="font-bold">Significant Impact</h3>
                    <p id="suggestion-significant" class="p-3 bg-red-50 border-l-4 border-red-500 rounded"></p>
                </div>

                <!-- Error -->
                <div id="error-message" class="hidden mt-4 p-4 bg-red-100 border-l-4 border-red-500 rounded">
                    <p class="font-bold">Analysis Failed</p>
                    <p id="error-text" class="text-sm"></p>
                </div>

            </div>
        </div>

        <div class="text-center text-xs text-gray-400 mt-4">
            User ID: <span id="display-user-id">Loading...</span>
        </div>

    </div>

<script>
    const imgPreview = document.getElementById('image-preview');
    const placeholder = document.getElementById('placeholder-text');
    const analyzeBtn = document.getElementById('analyzeButton');
    const resultsDiv = document.getElementById('results');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const displayUserId = document.getElementById('display-user-id');

    const dishField = document.getElementById('user-dish-name');
    const quantityField = document.getElementById('user-quantity');

    let imageBase64 = null;

    // Open camera
    function openCamera() {
        document.getElementById('cameraInput').click();
    }

    // Preview function (works for upload + camera)
    function previewImage(event) {
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            imgPreview.src = e.target.result;
            imgPreview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            analyzeBtn.disabled = false;

            imageBase64 = e.target.result.split(',')[1];
        };
        reader.readAsDataURL(file);
    }

    function showError(msg) {
        errorText.textContent = msg;
        errorDiv.classList.remove('hidden');
        resultsDiv.classList.add('hidden');
    }

    async function analyzeFood() {
        if (!imageBase64) return showError("No image uploaded.");

        analyzeBtn.disabled = true;
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');

        const userHints = `
${dishField.value ? `Dish Name: ${dishField.value}` : ""}
${quantityField.value ? `Quantity: ${quantityField.value}` : ""}
        `.trim();

        const payload = {
            contents: [
                {
                    role: "user",
                    parts: [
                        { text: "Analyze the food image using the optional user-provided hints below." },
                        { text: userHints || "No additional hints provided." },
                        { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }
                    ]
                }
            ]
        };

        try {
            const res = await fetch("https://abhineeth23-food-estimator-proxy.hf.space/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) throw new Error("Invalid AI response");

            const clean = text.replace(/```json|```/g, "").trim();
            const json = JSON.parse(clean);

            updateResults(json);

        } catch (e) {
            console.error(e);
            showError("The AI could not analyze the image.");
        }

        loadingDiv.classList.add('hidden');
        analyzeBtn.disabled = false;
    }

    function updateResults(data) {
        const fmt = n => typeof n === "number" ? n.toFixed(1) : "N/A";

        document.getElementById('food-description').textContent = data.foodDescription;
        document.getElementById('serving-size').textContent = `${fmt(data.estimatedServingSizeGrams)} g`;
        document.getElementById('calories').textContent = fmt(data.caloriesKcal);
        document.getElementById('protein').textContent = fmt(data.proteinGrams);
        document.getElementById('fat').textContent = fmt(data.fatGrams);
        document.getElementById('carbs').textContent = fmt(data.carbsGrams);
        document.getElementById('daily-impact').textContent = data.dailyImpactSummary;
        document.getElementById('suggestion-minimal').textContent = data.suggestionMinimalImpact;
        document.getElementById('suggestion-significant').textContent = data.suggestionSignificantImpact;

        resultsDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
    }

    window.onload = () => {
        const i = setInterval(() => {
            if (window.isAuthReady) {
                displayUserId.textContent = window.userId;
                clearInterval(i);
            }
        }, 100);
    };
</script>
</body>
</html>
